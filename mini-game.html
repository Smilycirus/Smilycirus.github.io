<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tiberium Clicker</title>
<style>
:root {
  --bg: #07080a;
  --panel: #101712;
  --panel-2: #0d140f;
  --text: #dff6df;
  --muted: #9fb39f;
  --accent: #7CFF7C;
  --border: #223527;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: "Segoe UI", Arial, sans-serif;
  color: var(--text);
  background: radial-gradient(circle at top, #12151a 0%, var(--bg) 60%);
}

a { color: inherit; }

.wrap {
  width: min(100% - 2rem, 1100px);
  margin: 0 auto;
  padding: 1rem 0 2.2rem;
}

.top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}

.back-link {
  text-decoration: none;
  color: #b8d8b8;
  border: 1px solid #38553f;
  border-radius: 8px;
  padding: 0.45rem 0.7rem;
  font-size: 0.92rem;
}

h1 {
  margin: 0;
  font-size: clamp(1.6rem, 4vw, 2.3rem);
  color: var(--accent);
}

.panel {
  background: linear-gradient(170deg, var(--panel), var(--panel-2));
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 1rem;
  box-shadow: 0 10px 30px rgba(0,0,0,0.28);
  position: relative;
}

.auth-panel { margin-bottom: 1rem; }
.auth-title {
  margin: 0 0 0.35rem;
  color: var(--accent);
  font-size: 1.05rem;
}
.auth-status {
  margin: 0 0 0.65rem;
  color: var(--muted);
  font-size: 0.9rem;
}
.auth-row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.55rem;
}
.auth-row input {
  background: #0a110c;
  color: var(--text);
  border: 1px solid #2b4631;
  border-radius: 10px;
  padding: 0.62rem 0.72rem;
  min-width: 200px;
}
.auth-note {
  margin: 0.6rem 0 0;
  color: var(--muted);
  font-size: 0.82rem;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 0.7rem;
  margin-bottom: 1rem;
}

.stat {
  background: #0a110c;
  border: 1px solid #1d3023;
  border-radius: 10px;
  padding: 0.75rem;
  position: relative;
}

.stat-label {
  font-size: 0.8rem;
  color: var(--muted);
  margin-bottom: 0.2rem;
}

.stat-value {
  font-size: 1.2rem;
  font-weight: 700;
}

.actions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.7rem;
  margin-bottom: 1rem;
  position: relative;
}

button {
  margin: 0;
  padding: 0.66rem 0.92rem;
  border-radius: 10px;
  border: 1px solid #2f4a35;
  background: linear-gradient(180deg, #142018, #0f1612);
  color: #e0f5e0;
  cursor: pointer;
  transition: transform 0.15s ease, border-color 0.15s ease;
  font-weight: 600;
}

button:hover {
  transform: translateY(-1px);
  border-color: #4d8c58;
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
  border-color: #2f4a35;
}

.primary {
  border-color: #4f915a;
  background: linear-gradient(120deg, #2f8e42, #246f34);
}

.section-title {
  margin: 0 0 0.65rem;
  color: var(--accent);
  font-size: 1.05rem;
}

.content-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 0.9rem;
}

.list {
  display: flex;
  flex-direction: column;
  gap: 0.55rem;
}

.row-item {
  background: #0a110c;
  border: 1px solid #1d3023;
  border-radius: 10px;
  padding: 0.65rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 0.4rem;
  flex-wrap: wrap;
}

.row-item span { color: #d0e8d0; }

.lock-note {
  display: block;
  margin-top: 0.25rem;
  font-size: 0.78rem;
  color: #f0c68f;
}

.achievement-earned {
  border-color: #226f58;
  background: #0b1715;
  color: #89f5db;
}

.footer-note {
  margin-top: 1rem;
  color: var(--muted);
  font-size: 0.9rem;
}

.floating-tiberium {
  position: absolute;
  color: #7CFF7C;
  font-weight: 700;
  animation: floatUp 0.8s ease-out forwards;
  pointer-events: none;
  user-select: none;
}

@keyframes floatUp {
  0% { transform: translateY(0); opacity: 1; }
  100% { transform: translateY(-50px); opacity: 0; }
}

#leaderboard {
  margin-top: 1rem;
  border: 1px solid #38553f;
  border-radius: 10px;
  padding: 0.7rem;
  background: #0d140f;
}

#leaderboard h2 {
  margin: 0 0 0.5rem;
  color: var(--accent);
}

#leaderboard ul {
  margin: 0;
  padding-left: 1rem;
}

#leaderboard li {
  margin-bottom: 0.25rem;
  color: #cce7cc;
}

@media (max-width: 900px) {
  .content-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <a class="back-link" href="index.html">‚Üê Back to Home</a>
    <h1>Tiberium Clicker</h1>
  </div>

  <main class="panel">
    <section class="panel auth-panel" aria-label="Account controls">
      <h2 class="auth-title">Account (Firebase)</h2>
      <p class="auth-status" id="authStatus">Not logged in</p>
      <div class="auth-row">
        <input id="username" type="text" placeholder="Username (new users)" aria-label="Username">
        <input id="email" type="email" autocomplete="username" placeholder="Email" aria-label="Email">
        <input id="password" type="password" autocomplete="current-password" placeholder="Password" aria-label="Password">
        <button onclick="createAccount()">Create Account</button>
        <button onclick="login()">Login</button>
        <button onclick="logout()">Logout</button>
      </div>
      <p class="auth-note">Account and save data are stored in Firebase. You must login to play/save.</p>
    </section>

    <section class="stats-grid" aria-label="Game stats">
      <div class="stat"><div class="stat-label">Tiberium</div><div class="stat-value" id="tiberium">0</div></div>
      <div class="stat"><div class="stat-label">TPS</div><div class="stat-value" id="tps">0</div></div>
      <div class="stat"><div class="stat-label">Prestige Crystals</div><div class="stat-value" id="prestige">0</div></div>
      <div class="stat"><div class="stat-label">Click Power</div><div class="stat-value" id="clickPower">1</div></div>
      <div class="stat"><div class="stat-label">Total Clicks</div><div class="stat-value" id="totalClicks">0</div></div>
      <div class="stat"><div class="stat-label">Total Earned</div><div class="stat-value" id="totalEarned">0</div></div>
    </section>

    <section class="actions">
      <button class="primary" onclick="clickTiberium()">Harvest (+<span id="harvestPreview">1</span>)</button>
      <button onclick="prestigeReset()">Prestige Reset</button>
      <button onclick="hardReset()">Full Reset</button>
    </section>

    <section class="content-grid">
      <article class="panel">
        <h2 class="section-title">Buildings</h2>
        <div id="buildings" class="list"></div>
      </article>

      <article class="panel">
        <h2 class="section-title">Upgrades</h2>
        <div id="upgrades" class="list"></div>
      </article>

      <article class="panel">
        <h2 class="section-title">Achievements</h2>
        <div id="achievements" class="list"></div>
      </article>
    </section>

    <section id="leaderboard" class="panel">
      <h2>Top 10 Players</h2>
      <ul id="leaderboardList"></ul>
    </section>

    <p class="footer-note">Tip: Prestige gives a permanent bonus to clicking and building production.</p>
  </main>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
import { getAnalytics } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
import { getFirestore, doc, getDoc, setDoc, collection, query, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

const firebaseConfig = {
  apiKey: 'AIzaSyDC2abQAAaQSxYxZ7g3_OKqQqlqPHCPyu4',
  authDomain: 'my-website-80cbb.firebaseapp.com',
  projectId: 'my-website-80cbb',
  storageBucket: 'my-website-80cbb.firebasestorage.app',
  messagingSenderId: '781604542143',
  appId: '1:781604542143:web:50a7bf43fe987a306a980a',
  measurementId: 'G-8BXHP342KD'
};

const app = initializeApp(firebaseConfig);
getAnalytics(app);
const auth = getAuth(app);
const db = getFirestore(app);

const numberFormatter = new Intl.NumberFormat('en-US', { maximumFractionDigits: 1 });
const LEGACY_SAVE_KEY = 'tibSave';

let game = createDefaultGame();
let currentUid = '';
let saveTimeout = 0;
let currentUsername = '';

// ==================== GAME DATA & FUNCTIONS ====================

function createDefaultGame() {
  return {
    tiberium: 0,
    totalClicks: 0,
    totalEarned: 0,
    clickPower: 1,
    prestigePoints: 0,
    lastUpdateTime: Date.now(),
    buildings: [
      { id: 'harvester', name: 'Harvester', cost: 10, owned: 0, production: 1, description: 'Slowly harvests Tiberium' },
      { id: 'refinery', name: 'Refinery', cost: 100, owned: 0, production: 10, description: 'Processes raw Tiberium' },
      { id: 'infantry', name: 'Infantry', cost: 1000, owned: 0, production: 100, description: 'Military unit production' },
      { id: 'tank', name: 'Tank', cost: 10000, owned: 0, production: 1000, description: 'Heavy armor division' },
      { id: 'airfield', name: 'Airfield', cost: 100000, owned: 0, production: 10000, description: 'Air superiority' }
    ],
    upgrades: [
      { id: 'sharpclick', name: 'Sharp Clicks', cost: 50, owned: 0, multiplier: 1.2, description: 'Increase click power by 20%', type: 'click' },
      { id: 'efficiency', name: 'Efficiency Module', cost: 500, owned: 0, multiplier: 1.15, description: 'Buildings produce 15% more', type: 'production' },
      { id: 'ionbeam', name: 'Ion Beam', cost: 5000, owned: 0, multiplier: 1.25, description: 'Advanced harvesting +25%', type: 'production' }
    ],
    achievements: [
      { id: 'first_harvest', name: 'First Harvest', description: 'Harvest 100 Tiberium', requirement: 100, type: 'totalEarned', earned: false },
      { id: 'industrialist', name: 'Industrialist', description: 'Own 10 total buildings', requirement: 10, type: 'buildings', earned: false },
      { id: 'billionaire', name: 'Billionaire', description: 'Earn 1,000,000 Tiberium', requirement: 1000000, type: 'totalEarned', earned: false },
      { id: 'clicker', name: 'Clicker', description: 'Click 10,000 times', requirement: 10000, type: 'totalClicks', earned: false }
    ]
  };
}

function normalizeGame(g) {
  const def = createDefaultGame();
  g.buildings = g.buildings || [];
  g.upgrades = g.upgrades || [];
  g.achievements = g.achievements || [];
  for (let b of def.buildings) {
    if (!g.buildings.find(x => x.id === b.id)) g.buildings.push({ ...b });
  }
  for (let u of def.upgrades) {
    if (!g.upgrades.find(x => x.id === u.id)) g.upgrades.push({ ...u });
  }
  for (let a of def.achievements) {
    if (!g.achievements.find(x => x.id === a.id)) g.achievements.push({ ...a });
  }
  return g;
}

function formatNum(n) {
  if (n >= 1e9) return numberFormatter.format(n / 1e9) + 'B';
  if (n >= 1e6) return numberFormatter.format(n / 1e6) + 'M';
  if (n >= 1e3) return numberFormatter.format(n / 1e3) + 'K';
  return Math.floor(n).toString();
}

function getTotalBuildingCount() {
  return game.buildings.reduce((sum, b) => sum + (b.owned || 0), 0);
}

function getProductionPerSecond() {
  let pps = 0;
  for (let b of game.buildings) {
    let prod = b.production || 0;
    for (let u of game.upgrades) {
      if (u.owned && u.type === 'production') prod *= u.multiplier;
    }
    pps += prod * (b.owned || 0);
  }
  return pps * (1 + game.prestigePoints * 0.1);
}

window.clickTiberium = function() {
  let power = game.clickPower;
  for (let u of game.upgrades) {
    if (u.owned && u.type === 'click') power *= u.multiplier;
  }
  power *= (1 + game.prestigePoints * 0.1);
  game.tiberium += power;
  game.totalClicks += 1;
  game.totalEarned += power;
  checkAchievements();
  scheduleUpdate();
};

window.buyBuilding = function(id) {
  let b = game.buildings.find(x => x.id === id);
  if (!b) return;
  if (game.tiberium >= b.cost) {
    game.tiberium -= b.cost;
    b.owned = (b.owned || 0) + 1;
    b.cost = Math.ceil(b.cost * 1.12);
    checkAchievements();
    scheduleUpdate();
  }
};

window.buyUpgrade = function(id) {
  let u = game.upgrades.find(x => x.id === id);
  if (!u) return;
  if (game.tiberium >= u.cost) {
    game.tiberium -= u.cost;
    u.owned = (u.owned || 0) + 1;
    u.cost = Math.ceil(u.cost * 1.15);
    checkAchievements();
    scheduleUpdate();
  }
};

function checkAchievements() {
  for (let a of game.achievements) {
    if (a.earned) continue;
    let unlocked = false;
    if (a.type === 'totalEarned' && game.totalEarned >= a.requirement) unlocked = true;
    if (a.type === 'totalClicks' && game.totalClicks >= a.requirement) unlocked = true;
    if (a.type === 'buildings' && getTotalBuildingCount() >= a.requirement) unlocked = true;
    if (unlocked) a.earned = true;
  }
}

window.prestigeReset = function() {
  if (game.totalEarned < 1000) { alert('Need 1,000 total earned to prestige.'); return; }
  const prestigeGain = Math.floor(Math.sqrt(game.totalEarned / 1000));
  game.prestigePoints += prestigeGain;
  game = createDefaultGame();
  game.prestigePoints += prestigeGain;
  game = normalizeGame(game);
  scheduleUpdate();
};

window.hardReset = function() {
  if (!confirm('Are you SURE? This resets everything and costs all prestige!')) return;
  game = createDefaultGame();
  game = normalizeGame(game);
  scheduleUpdate();
};

function createFloatingText(amount, x, y) {
  let el = document.createElement('div');
  el.className = 'floating-tiberium';
  el.textContent = '+' + formatNum(amount);
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  document.querySelector('.actions').appendChild(el);
  setTimeout(() => el.remove(), 800);
}

async function updateLeaderboard() {
  const q = query(collection(db,'clickerSaves'), orderBy('totalEarned','desc'), limit(10));
  const snap = await getDocs(q);
  const ul = document.getElementById('leaderboardList'); 
  ul.innerHTML = '';
  for(const docSnap of snap.docs) {
    const uid = docSnap.id;
    const saveData = docSnap.data();
    const userDoc = await getDoc(doc(db,'users',uid));
    const uname = userDoc.exists() ? userDoc.data().username || uid : uid;
    const li = document.createElement('li');
    li.textContent = `${uname}: ${formatNum(saveData.totalEarned||0)}`;
    ul.appendChild(li);
  }
}

function wireRows() {
  // Buildings
  const bDiv = document.getElementById('buildings');
  bDiv.innerHTML = '';
  for (let b of game.buildings) {
    const canAfford = game.tiberium >= b.cost;
    const item = document.createElement('div');
    item.className = 'row-item';
    item.innerHTML = `<div><strong>${b.name}</strong><span>${b.owned}</span><br><span class="lock-note">${b.description}</span></div><button ${canAfford ? '' : 'disabled'}>${formatNum(b.cost)}</button>`;
    item.querySelector('button').onclick = () => { window.buyBuilding(b.id); };
    bDiv.appendChild(item);
  }

  // Upgrades
  const uDiv = document.getElementById('upgrades');
  uDiv.innerHTML = '';
  for (let u of game.upgrades) {
    const canAfford = game.tiberium >= u.cost;
    const item = document.createElement('div');
    item.className = 'row-item';
    item.innerHTML = `<div><strong>${u.name}</strong><span>${u.owned}</span><br><span class="lock-note">${u.description}</span></div><button ${canAfford ? '' : 'disabled'}>${formatNum(u.cost)}</button>`;
    item.querySelector('button').onclick = () => { window.buyUpgrade(u.id); };
    uDiv.appendChild(item);
  }

  // Achievements
  const aDiv = document.getElementById('achievements');
  aDiv.innerHTML = '';
  for (let a of game.achievements) {
    const item = document.createElement('div');
    item.className = 'row-item' + (a.earned ? ' achievement-earned' : '');
    item.innerHTML = `<div><strong>${a.name}</strong><br><span class="lock-note">${a.description}</span></div>`;
    aDiv.appendChild(item);
  }
}

function update() {
  const now = Date.now();
  const delta = (now - game.lastUpdateTime) / 1000;
  game.lastUpdateTime = now;

  const pps = getProductionPerSecond();
  game.tiberium += pps * delta;
  game.totalEarned += pps * delta;

  document.getElementById('tiberium').textContent = formatNum(game.tiberium);
  document.getElementById('tps').textContent = formatNum(pps);
  document.getElementById('prestige').textContent = game.prestigePoints;
  document.getElementById('totalClicks').textContent = formatNum(game.totalClicks);
  document.getElementById('totalEarned').textContent = formatNum(game.totalEarned);

  let clickPower = game.clickPower;
  for (let u of game.upgrades) {
    if (u.owned && u.type === 'click') clickPower *= u.multiplier;
  }
  clickPower *= (1 + game.prestigePoints * 0.1);
  document.getElementById('clickPower').textContent = formatNum(clickPower);
  document.getElementById('harvestPreview').textContent = formatNum(clickPower);

  wireRows();
}

function scheduleUpdate() {
  clearTimeout(saveTimeout);
  update();
  saveTimeout = setTimeout(saveToDB, 1000);
}

async function saveToDB() {
  if (!auth.currentUser) return;
  try {
    const gameData = {
      ...game,
      lastUpdateTime: Date.now()
    };
    await setDoc(doc(db, 'clickerSaves', auth.currentUser.uid), gameData);
    await updateLeaderboard();
  } catch (e) {
    console.error('Save error:', e);
  }
}

async function loadFromDB() {
  if (!auth.currentUser) return false;
  try {
    const docSnap = await getDoc(doc(db, 'clickerSaves', auth.currentUser.uid));
    if (docSnap.exists()) {
      game = normalizeGame(docSnap.data());
      game.lastUpdateTime = Date.now();
      update();
      return true;
    }
  } catch (e) {
    console.error('Load error:', e);
  }
  return false;
}

// ==================== AUTHENTICATION ====================

function getCredentials() {
  return {
    email: document.getElementById('email').value.trim(),
    password: document.getElementById('password').value.trim()
  };
}

function clearCredentials() {
  document.getElementById('email').value = '';
  document.getElementById('password').value = '';
  document.getElementById('username').value = '';
}

window.createAccount = async function() {
  const { email, password } = getCredentials();
  const username = document.getElementById('username').value.trim();
  if (!email || !password || !username) {
    alert('Enter email, password, AND username.');
    return;
  }
  try {
    const cred = await createUserWithEmailAndPassword(auth, email, password);
    currentUid = cred.user.uid;
    currentUsername = username;
    await setDoc(doc(db, 'users', currentUid), { username });
    clearCredentials();
    updateAuthStatus();
    await loadFromDB();
  } catch (e) {
    alert(e.message || 'Error');
  }
};

window.login = async function() {
  const { email, password } = getCredentials();
  if (!email || !password) {
    alert('Enter both email/password.');
    return;
  }
  try {
    const cred = await signInWithEmailAndPassword(auth, email, password);
    currentUid = cred.user.uid;
    const uDoc = await getDoc(doc(db, 'users', currentUid));
    currentUsername = uDoc.exists() ? uDoc.data().username || cred.user.email : cred.user.email;
    clearCredentials();
    updateAuthStatus();
    await loadFromDB();
  } catch (e) {
    alert(e.message || 'Error');
  }
};

window.logout = async function() {
  await signOut(auth);
  currentUid = '';
  currentUsername = '';
  game = createDefaultGame();
  game = normalizeGame(game);
  updateAuthStatus();
  update();
};

function updateAuthStatus() {
  const s = document.getElementById('authStatus');
  if (auth.currentUser) {
    s.textContent = `Logged in as ${currentUsername || auth.currentUser.email}. Progress saves to Firebase.`;
  } else {
    s.textContent = 'Not logged in. Create an account or login to save progress.';
  }
}

// ==================== INITIALIZATION ====================

onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUid = user.uid;
    const uDoc = await getDoc(doc(db, 'users', user.uid));
    currentUsername = uDoc.exists() ? uDoc.data().username || user.email : user.email;
    updateAuthStatus();
    await loadFromDB();
  } else {
    currentUid = '';
    currentUsername = '';
    game = createDefaultGame();
    game = normalizeGame(game);
    updateAuthStatus();
    update();
  }
});

game = normalizeGame(game);
update();
setInterval(update, 100);

</script>
</body>
</html>
